<!DOCTYPE HTML>
<html>
	<head>
		<title>vkPlayerControlManager</title>
		<meta http-equiv="content-type" value="text/html">
		<script>
			// const 	go 			= 	safari.extension.settings;
			// const 	bars 		= 	safari.extension.bars;
			// const 	active 		= 	safari.application.activeBrowserWindow;
			// var 	setting 	= 	new Array();
			var kh_map_cmd;

			function onKeypressHandlerForAllOpenPages(msgEvent) {
				console.log(msgEvent);
				console.log(kh_map_cmd);
    			var messageName = msgEvent.name;
				if (messageName == "keypressHandler") {
					var keyCode = msgEvent.message;

							//http://web.archive.org/web/20100501161453/http://www.classicteck.com/rbarticles/mackeyboard.php

					var cmd_message =  kh_map_cmd.get(keyCode);
					if (cmd_message === undefined) {
						return;
					}


					var patt = new RegExp("/vk.com/");
					safari.application.browserWindows.forEach(function(item, i) {
	  					item.tabs.forEach(function(tab, j) {
	  						// console.log( i + ": " + tab.url + " (массив:" + 0 + ")" );
	  						    if (patt.test(tab.url)) {

	  						    	tab.page.dispatchMessage('vkPlayerControl',cmd_message);
	  						    }
	  						    console.log( j );
	  					});
	  					console.log( i );
					});
				}

				// return;

				// alert(safari.application);
				// // alert(safari.application.activeBrowserWindow.activeTab.url);
				// console.log(msgEvent);
    // 			var messageName = msgEvent.name;
    // 			var messageData = msgEvent.message;

    // 			event.target.page.dispatchMessage("theAnswer", safari.application);
    
			}

			// safari.application.activeBrowserWindow.activeTab.addEventListener("message", waitForMessage, false);
			// safari.application.activeBrowserWindow.addEventListener("message", waitForMessage, false);
			if (window == window.top) {
 				safari.application.addEventListener("message", onKeypressHandlerForAllOpenPages, false);


//http://web.archive.org/web/20100501161453/http://www.classicteck.com/rbarticles/mackeyboard.php
                // mac keys
			var keypressHandlerMapCMD = [
				["118", "prew"], 
				["119", "playtoggle"],
				["120", "next"], 
				["38", "volumeup"], 
				["40", "volumedown"], 
				];

				kh_map_cmd = new Map(keypressHandlerMapCMD);
			}
			


		</script>
	</head>
	<body></body>
</html>